name: Retail Analytics Pipeline CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate-python-syntax:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Check all Python files syntax
        run: |
          python -m py_compile kafka/producer.py
          python -m py_compile consumer/consumer.py
          python -m py_compile airflow/dags/retail_pipeline_dag.py
          echo "All Python files have valid syntax"

  test-kafka-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Kafka dependencies
        run: |
          pip install kafka-python pandas openpyxl
          echo "Kafka dependencies installed successfully"

  test-consumer-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Consumer dependencies
        run: |
          pip install kafka-python polars pyarrow
          echo "Consumer dependencies installed successfully"

  docker-build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build Kafka Producer Image
        run: |
          cd kafka
          docker build -t retail-producer:test .
          echo "Producer image built"
      
      - name: Build Kafka Consumer Image
        run: |
          cd consumer
          docker build -t retail-consumer:test .
          echo "Consumer image built"
